<script src="http://static.scripting.com/github/bootstrap2/js/jquery.js"></script>
<script src="http://static.scripting.com/github/bootstrap2/js/bootstrap-transition.js"></script>
<script src="http://static.scripting.com/github/bootstrap2/js/bootstrap-modal.js"></script>

<div id="talkDialog" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="windowTitleLabel" aria-hidden="true">
	<div class="modal-header">
		<a href="#" class="close" data-dismiss="modal">&times;</a>
		<h2 style="margin: 0px">&nbsp;</h2>
	</div>
	<div class="modal-body">
		<div class="alert alert-success" id="successMsg" style="display: none;">...</div>
		<div class="alert alert-info" id="infoMsg" style="display: none;">...</div>
		<div class="alert alert-warning" id="warningMsg" style="display: none;">...</div>
		<div class="alert alert-danger" id="dangerMsg" style="display: none;">...</div>	
		<div class="divDialogElements">
		<pre id="listenResult" style="height: 350px">
		
		</pre>
		</div>
	</div>
	<div class="modal-footer">
		<button type="button" onclick="$('#talkDialog').modal('hide')">OK</button>
	</div>
</div>

<form action="listen"><div class="form">

<div class="alert alert-danger" style="display: %ERROR_STATUS%">
  <a href="#" class="alert-link">%ERROR_MSG%</a>
</div>

%MOTES_TXT%

<p>Last 30 output lines:</p>

<div id="listen_div">%LISTEN_TXT%</div>

<br/>

<p>
	<input type="hidden" name="action" value="%MOTE_ACTION%"/>
	<input type="hidden" name="sma" class="Msma37" value="0">
	<input type="submit" value="%MOTE_ACTION% listening" %DISABLED%/>
</p>

<p>
	<label for="dataFile">Save data to file (empty to disable saving):</label><input type="text" name="dataFile" value="%DATA_FILENAME%" title="The file(s) will be created on your hard drive under web server's data directory. Existing files will be appended" %DISABLED% /><br/>
	<input type="radio" name="dataType" value="raw" title="Save all serial input without processing" %RAWDATA_CHECKED% %DISABLED%>&nbsp;Raw data</input><br/>
	<input type="radio" name="dataType" value="mprocessed" title="Save serial input in CSV format, each sensor data in a separate file" %MPROCDATA_CHECKED% %DISABLED%>&nbsp;CSV data, multiple files</input>
</p>

</div></form> 

<script language="javascript">
    var target = document.getElementById("listen_div");
    var text_output = "";
    var selectedMote;
    target.innerHTML="%LISTEN_TXT%";
    autoRefresh();
    
    function talkToMote(mote) {
    	$("#talkDialog").modal('show');
    	selectedMote = mote;
    	processListen();
    }
    
	function processListen() {
		refreshListenPage(selectedMote);
		setTimeout(processListen, 1000);
	}
	
	function refreshListenPage(mote) {
		$.ajax({
			type: "GET",
			url: "listen-single",
			data: "single=" + mote + "&max_data=100",
			dataType: "text",
			success: function(d) {
				text_output += d;
				arr = text_output.split("\n");
				outputSize = 21;
				if (arr.length > outputSize) {
					i = arr.length - outputSize;
					arr = arr.slice(i, i + outputSize);
					text_output = arr.join("\n");
				}
				$('#listenResult').text(text_output);
			},
			error: function() {
        		alert('Error occured');
   			}
		});
	}
</script>
